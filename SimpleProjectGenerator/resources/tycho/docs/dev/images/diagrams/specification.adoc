//-------1---------2---------3---------4---------5---------6---------7---------8---------9

// title break macro
:n: pass:q[<br>]
// forcing indentation
:__: {nbsp}{nbsp}

= Siemens EDA Software {n} VSE Analysis : Specifications
// Author line
Nicolas Peransin <nicolas.peransin@obeo.fr>
:revnumber: v1.0
:revdate: 2022-12-05
:revremark: Version Draft
:doctype: book

:sectnums:
:sectnumlevels: 1
// PDF use a specific chapter prefix
:chapter-label:

:toc:

<<<

== Overview

This document presents the design choices for current project.
As _Architect Explorer_ is an extension of Capella product, we can consider 2 main 
Use Cases:

- The user has an existing model and want to add _Architect Explorer_ capabilities.
- The user wants to create a new model knowing he needs Architect Explorer capabilities.

These 2 Use Cases must be covered in each UI set of actions.

VSE is the simulation engine this project must in bind into Capella worbench.


<<<

== Design rules for Meta-Modeling

_Architect Explorer_ must be integrated in Eclipse Capella components. +
This document presents why and how target elements are mapped on Capella elements.

Multiple implementations being possible, following design rules are the consideration to 
choose the proper one.

Existing elements for modeling ::
When a concept exists or is closed to an existing one, this concept should be used.

Existing display ::
When a representation exists, it should be used.

Elements limitation ::
The number of model element must be the lower possible. This implies using extension when 
using existing element requires adding several implicit elements. +
Because of Capella versatility, models grow rapidly, limiting extension impact is a good 
practice as several addons perform golbal analysis.


<<<

== Extension Naming and Labels

[TIP]
====

A business-friendly name must be used for tools labels. +
The name must be focused on specificities of the Add-on.

====

The expressed label is "VSE Analysis", this name will be used for banners.

<<<

== Mapping to Capella Elements

This chapter lists all elements the user can model that have a impact on the simulation. +
To do so, we mapped the expected elements of VSE with existing Capella Element or 
specific extension to ensure the most of feature is covered by the project. 

[TIP]
====
*Notation* +
< _?class_ > : Abstract +
< *field* > : non-null (required) +
- : identical +
# : extension +
<> field : composition +
>-< field : inverse relationship +
====

=== Common elements

image::model/images/Commons.jpg[align="center"]

[options="header", cols="1,2,1,1"]
|===
| Class \ Attribute          | Implementation           | Edition     | Notes
//----------------------
| _?NamedElement_            | ccore:NamedElement       |             | 
| {__} *name*                | -                        |             | 
| {__} *id*                  | -                        |             | 

| SimulationTime             | PhysicalArchitecture     |             | 
| {__} *simtime*             | -                        | Launch Cfg  | TBC: same place as start/stop time

| VseAutomationEnginePy      | < N/A >                  |             |
| {__} *path*                | < N/A >                  | Preferences | 
|===

=== Interfaces and Component Types

image::model/images/Components.jpg[align="center"]

[options="header", cols="4*"]
|===
| Class \ Attribute          | Implementation           | Edition     | Notes
//----------------------
| SenderReceiverInterface    | fa:ComponentExchange +
                               fa:ComponentPort         | [PAB][SWC]  | - Direct link +
                                                                        - Through Switch/Bus
| {__} *bufferSize*          | #bufferSize              | Properties  | Displayed in [PAB]
| {__} dataElements[*]       | [extension]              | [SWC]       | 

| _?VariableDataPrototype_   | [Extension]              | [SWC]       | There is no common elements between
                                                                           fa:ComponentExchange and fa:ComponentPort
| {__} type                  | #                        | Properties  | 
| {__} size                  | #                        | Properties  | 

| RandomData                 | [Extension]              | [SWC]       |
| {__} min                   | #                        | Properties  | 
| {__} max                   | #                        | Properties  | 

| FixData                    | [Extension]              | [SWC]       | Content define the type
| {__} defaultValue          | #                        | Properties  | 

| CustomData                 | [Extension]              | [SWC]       | Content define the type
| {__} path                  | #                        | Properties  | 

| ApplicationSwComponentType | pa:PhysicalComponent     | [PAB]       | Nature=Behavior +
                                                                           Contained by "Physical System" or sub-package.
| {__} <>ports               | ownedFeatures            | [PAB]       | 
| {__} <>internalBehavior    | <N/A>                    | -           | Implicitly 1

| ComportementPort           | fa:ComponentPort         | [PAB]       | container.nature=Behavior +
                                                                           No extension required
| {__} <>dest                | >-< componentExchanges   | [PAB]       | Constraint: cardinality == 1

| SwInternalBehavior         | <N/A>                    | -           | Implicit. Merged concept with PhysicalComponent
| {__} <>runnables[*]        | allocatedFunctions       | [PAB]       | 
| {__} <>events[*]           | allocatedFunctions. <PFunction>extensions +
                                  + allocatedFunctions. <PFunction>inputs
                                                        | [SWC]       | As each requires a Runnable, +
                                                                        it is easier to contain them into a runnable.
| RunnableEntity             | pa:PhysicalFunction      | [PAB]       | Owned by "Root Physical Function".
| {__} <>dataAccesses[*]     | (inputs + outputs)       |             | 

| DataAccess                 | info:PortAllocation      | [PAB]       | 
| {__} <container>           | <FunctionPort>target.container
                                                        | [PAB]       | 
| {__} *port*                | <container>              | [PAB]       | Owned by Port
| {__} *target*              | [extension]              | [SWC]       | Required by VariableDataPrototype being an extension
| Event                      | [Extension]              | [PAB]       | 
| {__} *startOn*             | <container>              | [PAB]       | Containment feature

| TimingEvent                | ccore:FloatPropertyValue | [PAB]       | 
| {__} *period*              | value                    | Properties  | 

| DataReceived               | ccore:FunctionInputPort  | [PAB]       | 
| {__} *dataAccess*          | [extension]              | Properties  | Must be consistent with Port Allocation
|===


=== Network topology

image::model/images/Network.jpg[align="center"]

[options="header", cols="4*"]
|===
| Class \ Attribute          | Implementation           | Edition     | Notes
//----------------------
| NetworkTopology            | < N/A >                  |             | Only a placeholder
| _?NetworkElement_          | pa:PhysicalComponent     |             | 
| CanBus                     | pa:PhysicalComponent     | [PAB]       | Nature=Node
| {__} <> interfaces[*]      | ownedFeatures            | [PAB]       | 
| CanBusInterface            | pa:ComponentPort         | [PAB]       | 
| {__} *baudrate*            | #                        | Properties  | 
| {__} *ref*                 | providedInterfaces       | [PAB]       | 
| EthSwitch                  | pa:PhysicalComponent     | [PAB]       | Nature=Node
| {__} interfaces[*]         | ownedFeatures. <pa:ComponentPort>
                                                        | [PAB]       | 
|===

image::model/images/ECUs.jpg[align="center"]


[options="header", cols="4*"]
|===
| Class \ Attribute          | Implementation           | Edition     | Notes
//----------------------
| ECU                        | pa:PhysicalComponent     | [PAB]       | Electrical Control Unit
| {__} <>socs[*]             | ownedFeatures.<Part>type | [PAB]       | 
| Soc                        | pa:PhysicalComponent     | [PAB]       | System-On-Chip
| {__} <>clusters[*]         | ownedFeatures.<Part>type | [PAB]       | 

| CpuCluster                 | pa:PhysicalComponent     | [PAB]       | 
| {__} <>cores[*]            | ownedFeatures.<Part>type | [PAB]       | 

| Core                       | pa:PhysicalComponent     | [PAB]       | 
| {__} <>mappings[*]         | ownedFeatures.<Part>type | [PAB]       | 

| CoreRunnableMapping        | pa:PhysicalComponent +
                                   + fa:ComponentFunctionalAllocation     
                                                        | [PAB]       | This concept is merged with 
                                                                        ApplicationSwComponentType partial modeling for
                                                                        Edition phase. +
                                                                        It requires dedicated data on allocated function.
| {__} *dest*                | ownedFunctionalAllocation. targetElement
                                                        |             | 
| {__} load                  | ownedFunctionalAllocation. [extension].load
                                                        |             | No Capella equivalence 
| {__} srcPath               | ownedFunctionalAllocation. [extension].srcPath
                                                        |             | No Capella equivalence
|===

=== Analysis

Analysis requires Capella Extensions.

image::model/images/Analysis.jpg[align="center"]

[options="header", cols="4*"]
|===
| Class \ Attribute          | Implementation           | Edition     | Notes
//----------------------
| ExchangeScale              | ComponentPort[Ext]       | [SWC]       |
| {__} *name*                | #                        |             | 
| {__} *scale*               | #                        |             | 
| {__} *port*                | <container>              |             | 

| _?LimitViolation_          | pa:PhysicalComponent     | [SWC]       | 
| {__} name                  | #                        |             | 
| {__} limit                 | #                        |             | 

| TimingRxViolation          | fa:FctInputPort[Ext]     | [SWC]       | 
| {__} *dest*                | <container>              |             | 

| MaxCpuViolation            | DataAccess[Ext]          | [SWC]       | 
| {__} *dest*                | <container>              |             | 

| AvgCpuViolation            | Soc[Ext]                 | [SWC]       | 
| {__} *dest*                | <container>              |             | 

| MaxEthViolation            | DataAccess[Ext]          | [SWC]       | 
| {__} *dest*                | <container>              |             | 

| RunnableMipsCalculation    | PhysicalFunction[Ext]    | [SWC]       | 
| {__} *name*                | #                        |             | 
| {__} *dest*                | <container>              |             | 

| Analysis                   | <N/A>                    |             | A placeholder.
| {__} <>*runconfig*         | -                        | Run config  | 
| {__} wireShark             | -                        | Run config  | 

| _?RunConfig_               | <N/A>                    | Run config  | Choosing active ECUs is
                                                                        supposed to be parameter
                                                                        for analysis
| _AllEcusConfig_            | <Run configuration>      | Run config  | a mode.
| _SelectEcusConfig_         | <Run configuration>      |             | a mode.


|===


<<<

== Representations

=== [PAB] Diagram Extension

This diagram is extension from Capella [PAB] Diagram.

The [PAB] is the most used diagram in Physical Architecture. Learning curve is the lowest
if most of edition interaction can be triggered from it.

==== Tools

🆕 Create <ECU|SOC|CpuCluster|Core|SwcMapping|Runnable> :: 
Create a Capella element with proper extension.

🆕 Create <EthSwitch | CanBus>::
Create a Component Node Ethernet Switch or a Can Bus.

🖌️ Apply Extension::
Apply an ArchExpl extension to an existing elements. +
This tool could be adaptive to selection:
- For PhysicalComponent in a Package with inner elements: ECU
- For PhysicalComponent in a Package with inner elements: Swith or EthBus
- For PhysicalComponent Node in a component according the containing element: 
Soc, CpuCluster, Core
- For PhysicalComponent Behavior : CoreRunnableMapping|Swc part 
- For Logical Function : Runnable

🚫 Remove Extension::
Opposite of 'Apply' action. +
It allows the user to change the extension without deleting Capella element. 

🔗 Link Ports::
Create an interface
- between SWC: creation of ports is automatic with proper orientation
- between a SWC and a Bus: creation of 2 ports 
- between a SWC and a Bus port: 

🔗 Allocate to Bus::
Route a direct connection using a Bus: A port is created on the bus and connector is 
splitted.

🔗 Create Data Access::
Create a Data Access from Runnable to Port.

🔗 Create TimingEvent::
Create a Data Access from Runnable to Port.

🆕 Create ExchangeScale :: 
Create a Exchange scale hint on Component Port.

🆕 Create <TimingRx|MaxCpu|AvgCpu|MaxEth>Violation::
Create a LimitViolation on targeted element.

🆕 Create RunnableMipsCalculation :: 
Create a RunnableMipsCalculation on a RunnableEntity.
	

==== Customization

A new layer "Arch Explorer" customizes mapped elements. User can choose 
"classic" or specific display.

[options="header", cols="3*,2"]
|===
| Item                | Model                      | Representation | Notes

| Physical Node       | ECU, Soc, CpuCluster, Core | Node Extension |
| Applied Behavior    | SwcMapping                 | Node Extension |
| Applied Function    | SenderReceiverInterface    | Node Extension |
| ComponentPort       | ComponentPort              | Node Extension |

| FunctionInputPort   | DataAccess                 | Node Extension | + PortAllocation.
                                                                             
| ComponentExchange   | SenderReceiverInterface    | Node Extension | Customise label with size
| TimingEvent         | TimingEvent                | Port           | <new>

|===

==== Validation

This rules are implied by the constraint of VSE format. +
They focus on the design choices user can make that are not supported for simulated model.

🚫 Container consistency::
- A ECU must be at top-level. +
- A SOC is contained by a ECU. (directly or not) +
- A CpuCluster is contained by a SOC. (directly or not) +
- A Core is contained by a CpuCluster. (directly or not). +
- A MappedSwc is a Deployed Physical Component from a Core. +
- A Runnable is allocated from MappedSwc.

🚫 Core Cardinality::
A CpuCluster can only have 1 core.

🚫 SWC ComponentPort orientation::
Port of SwcMapping must define a orientation In or Out. This indicates if the port is 
required or provided.

🚫 Switch/EthBus ComponentPort orientation::
Port of Switch/EthBus must not have any orientation and 2 ComponentExchanges.

🚫 Topology connection consistency::
Orientation for connected port must be consistent. (1 in, 1 out)

🚫 Unique names::
Names must be unique for 1 define level of architecture and a category.

=== Specific [SWC] Diagram

As the ApplicationSwComponentType has not single modeling element, there is no classic 
Capella representation. 
A specific diagram can help the user to understand how the system will be simulated.

image::diagrams/images/swc_sketch.jpg[align="center"]

==== Layout
[options="header", cols="1,1,1,2"]
|===
| Item                       | Container                  | Implementation | Display

| SenderReceiverInterface    | <root>                     | List           | <new: TBD>
| VariableDataPrototype      | SenderReceiverInterface    | ListItem       | Icon specific for each type

| ApplicationSwComponentType | <root>                     | Container      | [PAB]Behavior Node
| ComponentPort              | ApplicationSwComponentType | Port           | [PAB]ComponentPort: +
                                                                             Provided = Out arrow +
                                                                             Required = In arrow
                                                                             
| SwInternalBehavior         | <implicit>                 | <implicit>     | No representation
| RunnableEntity             | ApplicationSwComponentType | List           | [PAB]FunctionNode +
                                                                             ⚠️ SwInternalBehavior is implicit 
                                                                             and has no display.
| TimingEvent                | RunnableEntity             | ListItem       | 
| DataAccess                 | RunnableEntity             | Port+Node+Edge | Edge indicated the accessed port.

| Violation                  | <root>                     | Node+Edge      | Edge indicated the target.
| Violation                  | <root>                     | Node+Edge      | Edge indicated the target.

|===

==== Tools

In this [SWC] diagram, tool cover missing elements from [PAB] diagram.

🆕 Create ExchangeScale :: 
Create a Exchange scale hint on Component Port.

🆕 Create <TimingRx|MaxCpu|AvgCpu>Violation::
Create a LimitViolation on targeted element.

🆕 Create RunnableMipsCalculation :: 
Create a RunnableMipsCalculation on a RunnableEntity.


=== Configuration Overview Table

As Analysis parameter are defined on each target elements, user may need a synthesis of 
all parameters in 1 View.

For this kind summary, a Tree/Table view is an ergonomic choice. 

Mockup of expected representation. 

[options="header", cols="1,1,1"]
|===
| Parameters              | Value +
                            (Editable) | Destination
| 📏 Scales               |            |  
|  {__} + ExchangeScale 1 | <scale>    | <cmp>.<port>
| ⚠️ Violations           |            |  
|  {__} + TimingRx 1      | <limit>    | <cmp>.<bhv>.<dataAccess>
|  {__} + MaxCpu 1        | <limit>    | <cmp>.<bhv>.<dataAccess>
| 🖩 Calculations          |            |  
|  {__} + Calc l?         | - none -   | <cmp>.<bhv>.<runnable>
|===

==== Tools

❎ Delete parameter::
Remove an existing parameter from model. To create a Parametre

➡️ Show in Project Explorer 


<<<

== Project Management

To be able to use Architect Explorer extension, Kitalpha and Sirius specific Viewpoints 
must be activate in a Capella Projet.

2 mechanisms can be used:

- For existing project, add a "Configure Architect Explorer" item in _<Project>/Configure_ 
menu for Capella Project.
- Provide a specific "New Project" Wizard, extending Capella "new Project" Wizard.


<<<

== Launching VSE command

To launch a command requiring parameters in Eclipse, the most common way is to use 
_Preferences_ or _Run Configuration_ or both.

=== _Preferences_

_Preferences_ are values attached to the whole workspace or edition setup.

For _Architect Explorer_, _Preferences_ deal with:

- Default output directory (a default value relative to project path)
- Path to the Vista Engine directory
- Path to the Vista Engine executable file

=== _Run Configuration_

A "*Run Configuration*" stores information regarding command execution and but not 
modeling detail.

Implementation choice:
2 types of configuration are possible:

- "*Run Configuration*" provided by _org.eclipse.debug_
- or "*External Tools Configuration*" provided by _org.eclipse.ui.externalTools_

As _org.eclipse.ui.externalTools_ relies of _org.eclipse.debug_ and brings no 
more API, "*Run Configuration*" is preferred.

A "*Run Configuration*" is providing following attributes :

****
[plantuml, Run Configuration, png]
....
include::{includesdir}/diagrams/launch_configuration.plantuml[]
....
****

When launching a command, a new configuration is created with default value or user can 
create one directly in *Run Configuration* Dialog to specify ECU details. +


<<<

== Data Analysis Integration

The model can handle feedback from the simulation.

=== Data workflow

Once the simulation action is launched by the user, a sequence is performed to coordinate
to command flow and data.

At the end, a set of primitives is available for some model elements.

[plantuml, Simulation sequence, png]
....
include::{includesdir}/diagrams/simulation_sequence.plantuml[]
....

=== Simulation feedback Interface

So we will have 2 interfaces:

- VistaCsvParsing (temporary name) for loading Data, this could be:

[source,java]
----
    loadVseData(URI aird, File workingDir, CVSParser data); // if all traces are in 1 file
    loadVseData(URI aird, EObject context, File workingDir, CVSParser data); // for n generated files,
    // Important: We may need a better context signature according to Siemens implementation
----


- VistaPrimitiveProvider (temporary name) for accessing primitive,

[source,java]
----
    String getVseStringValue(EObject context, String primitive);
    int getVseIntegerValue(EObject context, String primitive);
    float getVseRealValue(EObject context, String primitive);
    boolean getVseBooleanValue(EObject context, String primitive);
----

=== Cost rules

The user should be able to define expression using the primitive to evaluate cost rule.

